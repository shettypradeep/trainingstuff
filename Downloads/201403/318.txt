From users-return-135783-apmail-maven-users-archive=maven.apache.org@maven.apache.org  Wed Mar 12 10:25:14 2014
Return-Path: <users-return-135783-apmail-maven-users-archive=maven.apache.org@maven.apache.org>
X-Original-To: apmail-maven-users-archive@www.apache.org
Delivered-To: apmail-maven-users-archive@www.apache.org
Received: from mail.apache.org (hermes.apache.org [140.211.11.3])
	by minotaur.apache.org (Postfix) with SMTP id B55A710263
	for <apmail-maven-users-archive@www.apache.org>; Wed, 12 Mar 2014 10:25:14 +0000 (UTC)
Received: (qmail 3171 invoked by uid 500); 12 Mar 2014 10:25:11 -0000
Delivered-To: apmail-maven-users-archive@maven.apache.org
Received: (qmail 2581 invoked by uid 500); 12 Mar 2014 10:25:09 -0000
Mailing-List: contact users-help@maven.apache.org; run by ezmlm
Precedence: bulk
List-Unsubscribe: <mailto:users-unsubscribe@maven.apache.org>
List-Help: <mailto:users-help@maven.apache.org>
List-Post: <mailto:users@maven.apache.org>
List-Id: "Maven Users List" <users.maven.apache.org>
Reply-To: "Maven Users List" <users@maven.apache.org>
Delivered-To: mailing list users@maven.apache.org
Received: (qmail 2569 invoked by uid 99); 12 Mar 2014 10:25:08 -0000
Received: from athena.apache.org (HELO athena.apache.org) (140.211.11.136)
    by apache.org (qpsmtpd/0.29) with ESMTP; Wed, 12 Mar 2014 10:25:08 +0000
X-ASF-Spam-Status: No, hits=-0.7 required=5.0
	tests=RCVD_IN_DNSWL_LOW,SPF_PASS
X-Spam-Check-By: apache.org
Received-SPF: pass (athena.apache.org: domain of jcarsique@nuxeo.com designates 74.125.82.41 as permitted sender)
Received: from [74.125.82.41] (HELO mail-wg0-f41.google.com) (74.125.82.41)
    by apache.org (qpsmtpd/0.29) with ESMTP; Wed, 12 Mar 2014 10:25:04 +0000
Received: by mail-wg0-f41.google.com with SMTP id n12so11224194wgh.0
        for <users@maven.apache.org>; Wed, 12 Mar 2014 03:24:42 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20130820;
        h=x-gm-message-state:message-id:date:from:user-agent:mime-version:to
         :subject:references:in-reply-to:content-type
         :content-transfer-encoding;
        bh=KhlxDP01Un9vB7dFd9JtyTMLu6kdcnVJaX9IrcS19Ks=;
        b=IoiWTZW1LeSbY1rjJ0N7iJ4/QRm0MLxlISHmZklN/4J7km8trFTg52QH8YW703FOVV
         dqGsFw4CFOGp1HZ3PYxlQ84UU/CJDBoqsd+RFLiFSdWfBA5z5ONxKTd3wyN0rUXuRthE
         XajYm0oGbFbSzVYxBknAiXBJErYEh6JpYecrjGo5t+llUe2u1+kLmyT9O1Ck6PLdJvE6
         ded3//1jwNWd0sE2lzO3Rlkfr3b1FkL2x0RiRtFLWGs2AI4/3SsVuBqUPWPl2QeWHqtm
         MHndkneMSlo2sZykFFqjTtrj/cWyp8S5P4ukVHwiqgCvT0QxUpQ6EcCrFwyIfe4dnjw7
         QaiQ==
X-Gm-Message-State: ALoCoQk2Bqm1y87pbp0lUGbIMSaUcs12NbyhTpcOti66djLw2LiafdA+fc/clffnLIIn8tyxKwMq
X-Received: by 10.181.11.169 with SMTP id ej9mr7008780wid.18.1394619882361;
        Wed, 12 Mar 2014 03:24:42 -0700 (PDT)
Received: from [10.213.3.69] ([176.57.246.10])
        by mx.google.com with ESMTPSA id t5sm68589011wjw.15.2014.03.12.03.24.41
        for <users@maven.apache.org>
        (version=TLSv1 cipher=ECDHE-RSA-RC4-SHA bits=128/128);
        Wed, 12 Mar 2014 03:24:41 -0700 (PDT)
Message-ID: <532035DB.8070802@nuxeo.com>
Date: Wed, 12 Mar 2014 11:24:27 +0100
From: Julien CARSIQUE <jcarsique@nuxeo.com>
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:24.0) Gecko/20100101 Thunderbird/24.2.0
MIME-Version: 1.0
To: Maven Users List <users@maven.apache.org>
Subject: Re: MDEPLOY-157 deployAtEnd option of maven-deploy-plugin broken
 after ant-assembly-maven-plugin execution
References: <53202CA4.3070401@nuxeo.com> <CAPLpRQJ1T3_inPbRDCvFEvorv6E3Ure=GCcRt6xp9Ti4-zD1og@mail.gmail.com>
In-Reply-To: <CAPLpRQJ1T3_inPbRDCvFEvorv6E3Ure=GCcRt6xp9Ti4-zD1og@mail.gmail.com>
X-Enigmail-Version: 1.6
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
X-Virus-Checked: Checked by ClamAV on apache.org

Indeed. Thanks for pointing at that thread.
That would suggest the behavior comes from my plugin which defines it's own lifecycle (extensions true), but that the
issue resides in the deployAtEnd implementation in maven-deploy-plugin.

However, a lot of plugins do define their own extensions/lifecycle without the same effect, isn't it?
Or is there a newer/better way than
https://github.com/nuxeo/ant-assembly-maven-plugin/blob/442c47747d1b32e5cb883cde4233f5b8846ea6f0/src/main/resources/META-INF/plexus/components.xml
?

On 12/03/2014 10:51, Tamás Cservenák wrote:
> Not sure about your questions, but your finding might explain (or be
> related) ti what was found by Karl in this thread
>
> http://markmail.org/thread/65b7o4so77i7delc
>
>
> Thanks,
> ~t~
>
>
> On Wed, Mar 12, 2014 at 10:45 AM, Julien CARSIQUE <jcarsique@nuxeo.com>wrote:
>
>> Hi,
>>
>> I recently discovered an issue between the "deployAtEnd" option of
>> "maven-deploy-plugin" and the execution of my plugin
>> "ant-assembly-maven-plugin" (based on Aether).
>>
>> I first though it had nothing to do with maven-deploy-plugin and revealed
>> a more general issue in my implementation, so
>> I posted on Aether mailing list [0] but Benjamin Bentmann answered it
>> could be a bug in the maven-deploy-plugin
>> implementation of deployAtEnd option [1]:
>>>> Aether has nothing to do with the way Maven manages class loaders for
>> plugins, i.e. you should reach out to the Maven
>> user list instead.
>>>> Also, your analysis suggests a bug in the maven-deploy-plugin in that
>> it relies on the erroneous assumption that a
>> single class loader is used per plugin through out a multi-module build.
>>
>> Here it the issue: the deployAtEndoption doesn't work after building a
>> module involving an execution of
>> ant-assembly-maven-pluginbecause a new "Class realm plugin" is then
>> created and its static fields are reset (in that
>> case, the
>> org.apache.maven.plugin.deploy.DeployMojo.readyProjectsCounterfield).
>>
>> Code from maven-deploy-plugin(readyProjectsCounterrestarted to zero will
>> never equal to reactorProjects.size(),
>> projectsReadywill be always false):
>>
>>     @Parameter( defaultValue = "${reactorProjects}", required = true,
>> readonly = true )
>>     private List<MavenProject> reactorProjects;
>>
>>     private static final AtomicInteger readyProjectsCounter = new
>> AtomicInteger();
>>
>> *    *org.apache.maven.plugin.deploy.DeployMojo.execute() {
>>         boolean projectsReady = readyProjectsCounter.incrementAndGet() ==
>> reactorProjects.size();
>>
>>
>> In the following sample case, the ant-assembly-maven-plugin is called by
>> the "nuxeo-distribution-resources" module.
>> After that, no deployment will ever happen since the static fields of
>> maven-deploy-plugin are reset, the counter
>> "readyProjectsCounter" restarted to zero will never reach the number of
>> "reactorProjects", "projectsReady" will be
>> always false:
>>
>> $ mvn clean deploy -Pqa -DskipTests -pl
>> nuxeo-functional-tests,nuxeo-launcher,nuxeo-distribution-resources -nsu
>> -X|grep maven-deploy-plugin
>>
>> [DEBUG] Goal:
>>  org.apache.maven.plugins:maven-deploy-plugin:2.8.1:deploy (default-deploy)
>> [INFO] --- maven-deploy-plugin:2.8.1:deploy (default-deploy) @
>> nuxeo-functional-tests ---
>> [DEBUG] org.apache.maven.plugins:maven-deploy-plugin:jar:2.8.1:
>> [DEBUG] *Created new class realm
>> plugin>org.apache.maven.plugins:maven-deploy-plugin:2.8.1*
>> [DEBUG] Importing foreign packages into class realm
>> plugin>org.apache.maven.plugins:maven-deploy-plugin:2.8.1
>> [DEBUG] Populating class realm
>> plugin>org.apache.maven.plugins:maven-deploy-plugin:2.8.1
>> [DEBUG]   Included: org.apache.maven.plugins:maven-deploy-plugin:jar:2.8.1
>> [DEBUG] Configuring mojo
>> org.apache.maven.plugins:maven-deploy-plugin:2.8.1:deploy from plugin realm
>> ClassRealm[plugin>org.apache.maven.plugins:maven-deploy-plugin:2.8.1,
>> parent: sun.misc.Launcher$AppClassLoader@4821e115]
>> [DEBUG] Configuring mojo
>> 'org.apache.maven.plugins:maven-deploy-plugin:2.8.1:deploy' with basic
>> configurator -->
>> [DEBUG] Goal:
>>  org.apache.maven.plugins:maven-deploy-plugin:2.8.1:deploy (default-deploy)
>>
>> [INFO] --- maven-deploy-plugin:2.8.1:deploy (default-deploy) @
>> nuxeo-launcher ---
>> [DEBUG] Configuring mojo
>> org.apache.maven.plugins:maven-deploy-plugin:2.8.1:deploy from plugin realm
>> ClassRealm[plugin>org.apache.maven.plugins:maven-deploy-plugin:2.8.1,
>> parent: sun.misc.Launcher$AppClassLoader@4821e115]
>> [DEBUG] Configuring mojo
>> 'org.apache.maven.plugins:maven-deploy-plugin:2.8.1:deploy' with basic
>> configurator -->
>> [DEBUG] Goal:
>>  org.apache.maven.plugins:maven-deploy-plugin:2.8.1:deploy (default-deploy)
>>
>> [INFO] --- maven-deploy-plugin:2.8.1:deploy (default-deploy) @
>> nuxeo-distribution-resources ---
>> [DEBUG] org.apache.maven.plugins:maven-deploy-plugin:jar:2.8.1:
>> [DEBUG] *Created new class realm
>> plugin>org.apache.maven.plugins:maven-deploy-plugin:2.8.1--724569306*
>> [DEBUG] Importing foreign packages into class realm
>> plugin>org.apache.maven.plugins:maven-deploy-plugin:2.8.1--724569306
>> [DEBUG] Populating class realm
>> plugin>org.apache.maven.plugins:maven-deploy-plugin:2.8.1--724569306
>> [DEBUG]   Included: org.apache.maven.plugins:maven-deploy-plugin:jar:2.8.1
>> [DEBUG] Configuring mojo
>> org.apache.maven.plugins:maven-deploy-plugin:2.8.1:deploy from plugin realm
>> ClassRealm[plugin>org.apache.maven.plugins:maven-deploy-plugin:2.8.1--724569306,
>> parent: sun.misc.Launcher$AppClassLoader@4821e115]
>> [DEBUG] Configuring mojo
>> 'org.apache.maven.plugins:maven-deploy-plugin:2.8.1:deploy' with basic
>> configurator -->
>>
>> Could someone explain or guess why/when a "new class realm
>> plugin>org.apache.maven.plugins:maven-deploy-plugin" is
>> created (in bold) instead of reusing the previous one?
>> Is there something wrong in my implementation about that? Or should I
>> rather create an
>> http://jira.codehaus.org/browse/MDEPLOY issue related to MDEPLOY-157?
>>
>> The full log of above reproduction case:
>> http://ubuntuone.com/0WeyQGBzaDacZWh97CwcvE
>> The ant-assembly-maven-plugin source code:
>> https://github.com/nuxeo/ant-assembly-maven-plugin
>> Issue management:
>> - https://jira.nuxeo.com/browse/NXBT-739 (Do not break depoyAtEnd option
>> of maven-deploy-plugin)
>> - http://jira.codehaus.org/browse/MDEPLOY-157 (Add deployAtEnd option for
>> multimodule projects)
>>
>> Thanks,
>>
>> [0] http://dev.eclipse.org/mhonarc/lists/aether-users/msg00385.html
>> [1] http://dev.eclipse.org/mhonarc/lists/aether-users/msg00386.html
>>
>>
>> --
>>
>> *Julien Carsique*
>> DevOps Nuxeo, Paris, France
>>
>>



---------------------------------------------------------------------
To unsubscribe, e-mail: users-unsubscribe@maven.apache.org
For additional commands, e-mail: users-help@maven.apache.org


